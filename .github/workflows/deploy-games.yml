name: Deploy Games to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - "games/**"
      - ".github/workflows/deploy-games.yml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install
        env:
          YARN_ENABLE_IMMUTABLE_INSTALLS: false

      - name: Build Wordle
        run: |
          cd games/wordle/web
          yarn build
        env:
          NODE_ENV: production

      - name: Build 2048
        run: |
          cd games/2048/web
          yarn build
        env:
          NODE_ENV: production

      - name: Build Asteroids
        run: |
          cd games/asteroids/web
          yarn build
        env:
          NODE_ENV: production

      - name: Prepare deployment directory
        run: |
          mkdir -p ./deploy

          # Copy each game to its own directory
          cp -r games/wordle/web/out ./deploy/wordle
          cp -r games/2048/web/out ./deploy/2048
          cp -r games/asteroids/web/out ./deploy/asteroids

          # Create index page
          cat > ./deploy/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Knicks-Knacks Games</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                min-height: 100vh;
                color: #fff;
              }
              .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 2rem;
              }
              h1 {
                text-align: center;
                font-size: 3rem;
                margin-bottom: 0.5rem;
                background: linear-gradient(90deg, #00d9ff, #00ff88);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
              }
              .subtitle {
                text-align: center;
                color: #888;
                margin-bottom: 3rem;
              }
              .games-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 2rem;
              }
              .game-card {
                background: rgba(255,255,255,0.05);
                border-radius: 16px;
                padding: 2rem;
                text-decoration: none;
                color: #fff;
                transition: transform 0.3s, box-shadow 0.3s;
                border: 1px solid rgba(255,255,255,0.1);
              }
              .game-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                border-color: rgba(0,217,255,0.5);
              }
              .game-card h2 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
              }
              .game-card p {
                color: #aaa;
                line-height: 1.6;
              }
              .game-card .play-btn {
                display: inline-block;
                margin-top: 1rem;
                padding: 0.75rem 1.5rem;
                background: linear-gradient(90deg, #00d9ff, #00ff88);
                color: #000;
                border-radius: 8px;
                font-weight: bold;
                text-transform: uppercase;
                font-size: 0.875rem;
              }
              footer {
                text-align: center;
                margin-top: 4rem;
                color: #666;
              }
              footer a { color: #00d9ff; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>Knicks-Knacks Games</h1>
              <p class="subtitle">A collection of web-based games</p>

              <div class="games-grid">
                <a href="./wordle/" class="game-card">
                  <h2>Wordle</h2>
                  <p>Guess the 5-letter word in 6 tries. Get feedback on each guess with colored tiles showing how close you are.</p>
                  <span class="play-btn">Play Now</span>
                </a>

                <a href="./2048/" class="game-card">
                  <h2>2048</h2>
                  <p>Slide numbered tiles on a grid to combine them and reach 2048. Use arrow keys or swipe to play.</p>
                  <span class="play-btn">Play Now</span>
                </a>

                <a href="./asteroids/" class="game-card">
                  <h2>Asteroids</h2>
                  <p>Classic arcade shooter. Navigate your ship, destroy asteroids, and survive as long as possible.</p>
                  <span class="play-btn">Play Now</span>
                </a>
              </div>

              <footer>
                <p>Built with Next.js | <a href="https://github.com/colorpulse6/knicks-knacks">View Source</a></p>
              </footer>
            </div>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./deploy

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
